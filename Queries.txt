--HOMEWORK 3 DataWarehouse

-- Creating external table referring to gcs path
CREATE OR REPLACE EXTERNAL TABLE `ny-rides-rc.ny_taxi.external_green_taxi_2022_data`
OPTIONS (
  format = 'PARQUET',
  uris = ['gs://mage-zoomcamp-rc-2022/green_tripdata_*.parquet']
);

-- Check green trip data
SELECT * FROM ny-rides-rc.ny_taxi.external_green_taxi_2022_data;

-- Check green trip data non-partitoned
SELECT * FROM ny-rides-rc.ny_taxi.green_taxi_2022_non_partitoned;

-- Create a non partitioned table from external table
CREATE OR REPLACE TABLE ny-rides-rc.ny_taxi.green_taxi_2022_non_partitoned AS
SELECT * FROM ny-rides-rc.ny_taxi.external_green_taxi_2022_data;

-- COUNT of records of the table
SELECT COUNT(*) FROM ny-rides-rc.ny_taxi.external_green_taxi_2022_data;

-- fare_amount with 0 
SELECT COUNT(*) FROM `ny-rides-rc.ny_taxi.green_taxi_2022_non_partitoned` WHERE fare_amount =0;


-- Create a partitioned table from external table
CREATE OR REPLACE TABLE ny-rides-rc.ny_taxi.green_taxi_2022_partitoned
PARTITION BY
  DATE(lpep_pickup_datetime) AS
SELECT * FROM ny-rides-rc.ny_taxi.external_green_taxi_2022_data;

-- Impact of partition

SELECT DISTINCT(PULocationID)
FROM ny-rides-rc.ny_taxi.green_taxi_2022_non_partitoned
WHERE DATE(lpep_pickup_datetime) BETWEEN '2022-06-01' AND '2022-06-30';


SELECT DISTINCT(PULocationID)
FROM ny-rides-rc.ny_taxi.green_taxi_2022_partitoned
WHERE DATE(lpep_pickup_datetime) BETWEEN '2022-06-01' AND '2022-06-30';


-- Creating a partition and cluster table with strategy Partition `lpep_pickup_datetime` and 
-- Cluster `PULocationID` 
CREATE OR REPLACE TABLE ny-rides-rc.ny_taxi.green_taxi_2022_partitoned_clustered
PARTITION BY DATE(lpep_pickup_datetime)
CLUSTER BY PULocationID AS
SELECT * FROM ny-rides-rc.ny_taxi.external_green_taxi_2022_data;


-- BONUS
-- It estimates 0 B because of the aggregation in COUNT
SELECT COUNT(*) FROM ny-rides-rc.ny_taxi.green_taxi_2022_non_partitoned;

SELECT COUNT(*) FROM ny-rides-rc.ny_taxi.external_green_taxi_2022_data;
-- 
SELECT count(*) as trips
FROM ny-rides-rc.ny_taxi.green_taxi_2022_partitoned
WHERE DATE(lpep_pickup_datetime) BETWEEN '2022-06-01' AND '2022-12-31';

-- 
SELECT count(*) as trips
FROM ny-rides-rc.ny_taxi.green_taxi_2022_partitoned_clustered
WHERE DATE(lpep_pickup_datetime) BETWEEN '2022-06-01' AND '2022-12-31';